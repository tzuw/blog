---
title: "Java Multi-threading 第一篇"
subtitle: "Java Multi-threading (1)"
layout: post
catalog: true
author: "tzuw"
date: 2020-04-01 10:18:00
tags: [多線程, java高并发系列, synchronized, Semaphore, leetcode, 学习笔记]
categories: [java高并发系列]
---



### Process vs. Thread

Process 稱作進程，由一段程式碼 (Program) 生成的執行個體。它包含了一個 memory space，以及一個以上的執行緒。

Thread 稱作執行緒，是作業系統能夠排程的最小單位。一個 Thread 又包含了 Stack ，它是用來記錄函數的呼叫路徑和函數中的區域變量的。執行緒有四種狀態：Running, Suspended, Blocked, Terminated.

所以，可以小小的總結：

1.  一個進程的多個執行緒們，共享了一個 memory space，並且他們都擁有自己獨立的 Stack。
2.  作業系統會根據進程的優先順序，分別讓各個進程佔據一段CPU時間，而各個進程又會再安排 Thread 輪流執行。



Thread 的方法

1.  執行緒的 sleep() 或 yeild() 方法
2.  synchronized 可以用於修飾方法或者一個區塊



參考資料

1.  [https://dotblogs.com.tw/frankblog/2017/03/06/210644](https://dotblogs.com.tw/frankblog/2017/03/06/210644)



### 死鎖

執行緒之間互搶資源，則可能產生死結（Deadlock）。

-   禁止搶占 no preemption - 系統資源不能被強制從一個行程中登出
-   持有和等待 hold and wait - 一個行程可以在等待時持有系統資源
-   互斥 mutual exclusion - 只有一個行程能持有一個資源
-   迴圈等待 circular waiting - 一系列行程互相持有其他行程所需要的資源



### synchronized 和 lock

在 Lock 期間，鎖定同一物件的其他 Synchronized 區塊，會因為無法取得物件的 Lock 而等待

```java
當程式會需要取出某一個共用的物件且會判斷物件內容值，或更新物件內容時，
為了保證這些代碼的同步性，一般要用到 synchronized
  
synchronized public void syncMethod() {
  // write your code here
}

synchronized static public void syncMethod() {
  // write your code here
}

public void syncMethod() {
  synchronized(this) {
    // write your code here
  }
}

public void syncMethod() {
  synchronized(SomeObject) {
    // write your code here 
    // 不代表不能更改 SomeObject 中的屬性哦，而且和 synchronized 修飾的方法無法形成同步關係
  }
}

public void syncMethod() {
  synchronized (XXX.class) {
    //Class锁对类的所有对象实例起作用
  }
}
```



**synchronized(this) vs. synchronized(.class)** 

对一个实例上锁；对所有的实例都会锁，就像一个静态的synchronized方法，即该类的所有实例调用这段代码时都是同步进行的。





###  Semaphore Class

是 java.util.concurrent 包下的类，用于帮助程序员写关于 thread 的代码。[這裡](https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/Semaphore.html)是 Semaphore 的官方文檔。它可以理解为一种信号量控制，有效地限制资源被访问的次数。Semaphore 可以被用來實現互斥鎖，即只有一個許可的時候。

-   如何使用？

    有 acquire()，release() 兩個方法，分別標示獲取和釋放一個用來獲取資源的許可。資源獲取失敗的話，線程就會被 block。並且拋出 InterruptedException 異常。

    

    -   boolean tryAcquire()
    -   boolean tryAcquire(int permits)
    -   boolean tryAcquire(long timeout, TimeUnit unit) throws InterruptedException
    -   boolean tryAcquire(int permits, long timeout, TimeUnit unit) throws InterruptedException

-   可能产生的异常

    在finally里面释放锁可能會有問題

    响应线程中断，觸發 InterruptedException 異常。



**官方文檔上的例子**

-   一个线程的release()方法happen-before另外线程的acquire()

```java
class Pool {
  private static final int MAX_AVAILABLE = 100;
  private final Semaphore available = new Semaphore(MAX_AVAILABLE, true);

  public Object getItem() throws InterruptedException {
    available.acquire();
    return getNextAvailableItem();
  }

  public void putItem(Object x) {
    if (markAsUnused(x))
      available.release();
  }

  // Not a particularly efficient data structure; just for demo

  protected Object[] items = ... whatever kinds of items being managed
    protected boolean[] used = new boolean[MAX_AVAILABLE];

  protected synchronized Object getNextAvailableItem() {
    for (int i = 0; i < MAX_AVAILABLE; ++i) {
      if (!used[i]) {
        used[i] = true;
        return items[i];
      }
    }
    return null; // not reached
  }

  protected synchronized boolean markAsUnused(Object item) {
    for (int i = 0; i < MAX_AVAILABLE; ++i) {
      if (item == items[i]) {
        if (used[i]) {
          used[i] = false;
          return true;
        } else
          return false;
      }
    }
    return false;
  }
```



-   公平性

```java
Semaphore(int permits) // 随机
Semaphore(int permits, boolean fair) // 等待时间最长的线程优先
```



**延伸閱讀**

https://www.cnblogs.com/itsoku123/p/11223837.html

https://blog.csdn.net/javazejian/article/details/76167357

https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/Semaphore.html

https://docs.oracle.com/javase/tutorial/essential/concurrency/syncmeth.html

http://tutorials.jenkov.com/java-util-concurrent/semaphore.html

https://zhuanlan.zhihu.com/p/56961571

https://blog.csdn.net/flyingdon/article/details/5110582

https://blog.csdn.net/J080624/article/details/85625350?depth_1-utm_source=distribute.pc_relevant.none-task&utm_source=distribute.pc_relevant.none-task





### 參考資料

1.  [https://www.jackforfun.com/java-synchronized](https://www.jackforfun.com/java-synchronized)

2.  [https://blog.csdn.net/luckey_zh/article/details/53815694](https://blog.csdn.net/luckey_zh/article/details/53815694)

3.  [系列文：30天介绍Java Thread](https://ithelp.ithome.com.tw/articles/10203988)

4.  [Semaphore.Release 方法](https://docs.microsoft.com/zh-tw/dotnet/api/system.threading.semaphore.release?view=netframework-4.8)

5.  https://docs.microsoft.com/zh-tw/dotnet/api/system.threading.semaphore?view=netframework-4.8

    C# otz
