---
layout: post
title: "MongoDB 第二篇 基本使用方法"
subtitle: "MongoDB 第二篇 基本使用方法"
date: 2020-05-21 17:32:00
catalog: true
author: "tzuw"
header-img:  "img/cement.png"
tags: [MongoDB, CRUD] 
categories: [資料倉儲]
---

這篇筆記內容包括了 MongoDB 的基本 CRUD  操作，以及視圖的創建和修改。

### 概念

在 MongoDB 中，每筆資料稱為一個**文檔** **Document**，大概就是對應到傳統資料庫的 **Row**。而裝這些 Documents 的叫做**集合** **Collection**，抽象點的話可以對應到傳統資料庫的 **Table**。此外，**視圖 View** 是由 aggregation pipeline 所定義，而 aggregation pipeline 則是作用在另一個視圖或是集合上 ，並且你可以在視圖上執行 find 指令進行查詢。視圖的資料只會在查詢的時候會被創建，並且視圖不支持寫操作。



### 資料型態

由於 MongoDB 的文檔使用的是  BSON，所以相較於 JSON 支持更多類型的資料型態，例如日期和 Raw Binary。



### 常用的指令 - CRUD

```javascript
// 創建

use five9one; // create db in the same time

db.getCollection("houses").find({linkman: "歐小姐"})

db.houses.insert({
    "id" : "1997528-9074205",
    "url" : "https://rent.591.com.tw/rent-detail-9074205.html",
    "name" : "台北市-大同區-國中北路132巷永福橋.國中路.溫馨機能型設計感套房",
    "regionid" : "3",
    "linkman_role" : "2", "linkman" : "曾小姐", "tel" : "0906288237",
    "kind" : "2", "shape" : "1", "sex_requirement" : "0",
    "price" : "11,888 元/月", "area" : "9 坪", "layout" : "", 
    "update_time" : "Sun Apr 19 22:05:02 2020"
});

// 創建視圖
db.createView("briefInfo", "houses", [
  {
    $project: {
    linkman: 1,
    url: { $substr: [ "$url", 8, -1 ] },
    tel: 1
    }
  }]
)


// Modify a view in order to only find out phone nums with character '轉'
// 修改上面的視圖 briedInfo，為了找出電話裡面包含 '轉' 的資料
// 在 pipeline 中包含了一個 $project 和 $match，有點 MySQL 裡面 select 和 where 的感覺
db.runCommand({
  collMod: "briefInfo", 
  viewOn: "houses", 
  pipeline: [
    {
      $project: {
        linkman: 1,
        tel: 1,
        url: { 
          $substr: [ "$url", 8, -1 ]
        }
      }
    },
    { 
      $match: {
        tel: {
          $regex: "[0-9]+ 轉 [0-9]+"
        }
      }
    }
  ]
})

// insertOne() insertMany() 注意 _id 欄位如果沒有指定，將自動生成
db.five9one.insertOne(
{
   "url":"https://rent.591.com.tw/rent-detail-9074205.html",
   "name":"新XX-XX區-XX路XXX巷永福橋.國中路.XXX型設計感套房",
   "regionid":"3", "linkman_role":"2", "linkman":"X小姐", "tel":"090XX88XX7",
   "kind":"2", "shape":"1", "sex_requirement":"0", "id":"1997528-9074205",
   "price":"11,888 元/月", "area":"9 坪", "layout":"",
   "update_time":"Sun Apr 19 22:05:02 2020"
})

// db.dropDatabase()

```



```javascript
// 讀取 查詢
db.five9one.find({})

// use "less than" operator to find houses with prices less than 12000
db.five9one.find( { "price": { $lt: 12000 } } )

// 也可以在嵌套的欄位上查詢
```



```javascript
// 更新
db.collection.updateOne(<filter>, <update>, <options>)

db.five9one.update_many(
    {"tel": "090XX88XX7"},
    {"$set": {"price": "-1", "tel": "-1"},
     "$currentDate": {"update_time": True}
    })

// db.collection.replaceOne()
// example in python
response = self.__collection.replace_one({'id': house['id']}, house, upsert=True)

```



```javascript
// 刪除
db.collection.deleteMany({tel: "090XX88XX7"})
db.collection.deleteOne({tel: "090XX88XX7"})
```



### 參考資料

1.  [https://docs.mongodb.com/manual/reference/method/](https://docs.mongodb.com/manual/reference/method/)
2.  [$regex](https://docs.mongodb.com/manual/reference/operator/query/regex/)
3.  [https://www.mongodb.com/json-and-bson](https://www.mongodb.com/json-and-bson)

