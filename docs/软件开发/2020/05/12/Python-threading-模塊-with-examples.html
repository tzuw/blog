<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="latte-a-little-sugar">
    <meta name="keywords"  content="">
    <meta name="theme-color" content="#000000">

    <!-- Open Graph -->
    <meta property="og:title" content="Python threading 模塊帶範例 - GINGER">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="之前剛好用到了 Python 的多線程模塊。一直有一個模糊的印象，大概有三種 threading、multiprocessing、concurrent.futures …… 等，趁這個機會來把相關的知識點整理整理。首先，釐清一個觀念，Python 中雖然有 GIL 去讓每次只有一個執行緒在跑，但是 Python 它不是 thread-free 的，比如常見的累加操作 +=1 就不是 atom...">
    
    <meta property="article:published_time" content="2020-05-12T00:23:00Z">
    
    
    <meta property="article:author" content="tzuw">
    
    
    <meta property="article:tag" content="thread">
    
    <meta property="article:tag" content="lock">
    
    <meta property="article:tag" content="Semaphore">
    
    <meta property="article:tag" content="Python">
    
    <meta property="article:tag" content="软件开发">
    
    
    <meta property="og:image" content="http://0.0.0.0:4000/blog/blog/img/sword.jpg">
    <meta property="og:url" content="http://0.0.0.0:4000/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91/2020/05/12/Python-threading-%E6%A8%A1%E5%A1%8A-with-examples.html">
    <meta property="og:site_name" content="GINGER">

    <title>Python threading 模塊帶範例 - GINGER</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/blog/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/blog/img/sword.jpg">

    <!-- Canonical URL -->
    <link rel="canonical" href="http://0.0.0.0:4000/blog/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91/2020/05/12/Python-threading-%E6%A8%A1%E5%A1%8A-with-examples.html">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/blog/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/blog/css/william-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog/">GINGER</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/blog/">Home</a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a href="/blog/about.html">About</a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="/blog/archive.html">Archive</a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="/blog/categories.html">Category</a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li>
                        <a href="/blog/tags.html">Tag</a>
                    </li>
                    
                    
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script type="module">
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from
     * $toggle/$collapse will break global delegation.
     *
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/blog/img/cement.png" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/blog/img/cement.png');
        background: ;
    }

    
</style>

<header class="intro-header" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/blog/tags.html?tags=thread" title="thread">#thread</a>
                        
                        <a class="tag" href="/blog/tags.html?tags=lock" title="lock">#lock</a>
                        
                        <a class="tag" href="/blog/tags.html?tags=Semaphore" title="Semaphore">#Semaphore</a>
                        
                        <a class="tag" href="/blog/tags.html?tags=Python" title="Python">#Python</a>
                        
                        <a class="tag" href="/blog/tags.html?tags=%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91" title="软件开发">#软件开发</a>
                        
                        <span>
                        
                        <a class="tag" href="/blog/categories.html?categories=软件开发" title="软件开发">☖软件开发</a>
                        
                        </span>
                    </div>
                    <h1>Python threading 模塊帶範例</h1>
                    
                    <h2 class="subheading">Python threading module with examples</h2>
                    <span class="meta">
                        May 12, 2020
                    </span>
                    <span>
                        约17分钟读完
                        大约5840个字
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>







<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

                <div id="app">
                    <p>之前剛好用到了 Python 的多線程模塊。一直有一個模糊的印象，大概有三種 threading、multiprocessing、concurrent.futures …… 等，趁這個機會來把相關的知識點整理整理。首先，釐清一個觀念，Python 中雖然有 GIL 去讓每次只有一個執行緒在跑，但是 Python 它不是 thread-free 的，比如常見的累加操作 <code class="highlighter-rouge">+=1</code> 就不是 atomic 的。然後，按部就班地先來看如何定義 Python 中的一個線程吧。</p>

<h3 id="先備知識---定義一個線程">先備知識 - 定義一個線程</h3>

<p>線程，指的是作業系統處理工作的基本單元。作業系統會根據 Thread 的優先權，以及使用過的 CPU 時間，在不同的 Thread 之間切換，讓各個 Thread 都有執行的機會。而同一個 Process 下的 Thread 使用相同的內存空間，共享全局變量、記憶體。而這些 Thread 又擁有自己的 Stack。即，可以通過參照獲取相同的物件，但是局部變量 (local variable) 獨立。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">threading</span>

<span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">"function called by thread </span><span class="si">%</span><span class="s">i</span><span class="se">\n</span><span class="s">"</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">return</span>

<span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">function</span> <span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>Output:
function called by thread 0

function called by thread 1

function called by thread 2

function called by thread 3

function called by thread 4

</pre></td></tr></tbody></table></code></pre></div></div>

<p>上面利用了 <code class="highlighter-rouge">threading.Thread(target=function)</code> 定義了線程，並且使用 join() 使得每個線程執行結束後才會進行接下去的迴圈。除此之外，你也可以自己定義一個線程類繼承至 <code class="highlighter-rouge">Thread</code>並實現 __ init __ 和 run 方法，同樣可以使用 <code class="highlighter-rouge">start()</code> 方法來開始一個線程，這邊就不展開啦。</p>

<h3 id="什麼是線程同步-synchronous">什麼是線程同步 Synchronous</h3>

<p>線程同步描述的是，線程之間在共享資源時的存取規則，即有一個線程在對某個<strong>共享變量</strong>進行讀寫時，其他線程將被阻塞，知道上一個線程釋放了鎖。(按預定的先後順序執行) 它預防了<strong>死鎖</strong>、異常線程順序的發生。</p>

<p><code class="highlighter-rouge">shared_resource_lock = threading.Lock()</code> 、<code class="highlighter-rouge">lock = threading.RLock()</code> 、 <code class="highlighter-rouge">semaphore = threading.Semaphore(0)</code>、 <code class="highlighter-rouge">condition = Condition()</code> 、<code class="highlighter-rouge">event = Event()</code> 、<code class="highlighter-rouge">Queue</code>  ，這些鎖們都可以用來實現線程同步。它們分別是，鎖 Lock、遞歸鎖 Reentrant Lock (RLock)、信號量 Semaphore、條件 Condition、事件 Event。</p>

<p>此外，使用 <code class="highlighter-rouge">with</code> 語句。</p>

<p><strong># Reentrant Lock 遞歸鎖/重入锁</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="rouge-code"><pre><span class="c1"># Reentrant Lock Example 遞歸鎖/重入锁
# 只有放鎖的人可以解鎖。解鈴還須繫鈴人。並且，同一個線程可以獲取多次這個 RLock。當然，同時也要釋放多次。
# 實現一個往箱子裡放/取 item 的多線程程式。只有把東西放進去的人，將鎖釋放後，才可以有人把東西拿出來。
</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="k">class</span> <span class="nc">Box</span><span class="p">():</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_items</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">Box</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span> <span class="c1"># 第二次獲取鎖
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">total_items</span> <span class="o">+=</span> <span class="n">n</span> <span class="c1"># manipulate total_items synchronously
</span>        <span class="n">Box</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span> <span class="c1"># 第一次釋放鎖
</span>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">Box</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">blocking</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="k">print</span> <span class="p">(</span><span class="s">'add is waiting for lock being released'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"adding 1 item in the box"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Box</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_items</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="p">(</span><span class="s">'Nothing to remove.'</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">Box</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">blocking</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="k">print</span> <span class="p">(</span><span class="s">'remove is waiting for lock being released'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"removing 1 item in the box"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_items</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Box</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">adder</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">items</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">box</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">-=</span> <span class="mi">1</span>
        
<span class="k">def</span> <span class="nf">remover</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">items</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">box</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">-=</span> <span class="mi">1</span>
        
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">items</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"putting </span><span class="si">%</span><span class="s">s items in the box "</span> <span class="o">%</span> <span class="n">items</span><span class="p">)</span>
    <span class="n">box</span> <span class="o">=</span> <span class="n">Box</span><span class="p">()</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">adder</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">items</span><span class="p">))</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">remover</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">items</span><span class="p">))</span>
    <span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">t2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">s items still remain in the box "</span> <span class="o">%</span> <span class="n">box</span><span class="o">.</span><span class="n">total_items</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>Output:
putting 5 items in the box
adding 1 item in the box
removing 1 item in the box 1
adding 1 item in the box
removing 1 item in the box 1
adding 1 item in the box
Nothing to remove.
removing 1 item in the box 1
adding 1 item in the box
removing 1 item in the box 1
adding 1 item in the box
removing 1 item in the box 1
0 items still remain in the box
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong># threading.Semaphore 信號量</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="c1"># threading.Semaphore 信號量
# 信號量標明了一個共享資源可以有多少並發存取
# 當信號量=1時，可以作為一個互斥量。即實現資源的互斥訪問。
# 實現一個信號量標示箱子裡還有多少 item 可以被使用，比如這個 item 可以被用來對某網站進行爬蟲
</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="n">semaphore</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">order</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">def</span> <span class="nf">crawler</span><span class="p">():</span>
    <span class="c1"># thread function
</span>    <span class="k">global</span> <span class="n">order</span>
    <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">+=</span><span class="mi">1</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'{} is crawlering on {}th url'</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span>
                <span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">order</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        
<span class="n">Threads</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">crawler</span><span class="p">)</span>
    <span class="n">Threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">Threads</span><span class="p">:</span>
    <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    
<span class="k">print</span><span class="p">(</span><span class="s">'Spider end.'</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>Output:
Thread-6 is crawlering on 1th url
Thread-5 is crawlering on 2th url
Thread-7 is crawlering on 3th url
Thread-9 is crawlering on 4th url
Thread-8 is crawlering on 5th url
Thread-10 is crawlering on 6th url
Thread-11 is crawlering on 7th url
Thread-12 is crawlering on 8th url
Thread-13 is crawlering on 9th url
Thread-14 is crawlering on 10th url
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong># Condition</strong></p>

<p>注意，<code class="highlighter-rouge">condition.wait()</code> 、<code class="highlighter-rouge">condition.notify()</code> 、<code class="highlighter-rouge">condition.acquire()</code> 、<code class="highlighter-rouge">condition.release()</code> 的使用，和關於線程的面試題。（按照順序打印 ABC 10次）</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c1"># 使用條件 Condition
# 解釋 Condition 同步機制可以用緩存，一個生產者-消費者機制的體現。
# 只要緩存沒滿的時候，生產者持續寫入。
# 只要緩存非空，消費者就不停的吃。
# 所以，當緩存隊列不為空時，生產者通知消費者。當緩存隊列不滿的時候，消費者通知生產者。
# 下面這段代碼是一個生產 20 個，然後消耗 20 個的例子。
</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">python</span><span class="o">-</span><span class="n">parallel</span><span class="o">-</span><span class="n">programmning</span><span class="o">-</span><span class="n">cookbook</span><span class="o">.</span><span class="n">readthedocs</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">zh_CN</span><span class="o">/</span><span class="n">latest</span><span class="o">/</span><span class="n">chapter2</span><span class="o">/</span><span class="mi">09</span><span class="n">_Thread_synchronization_with_a_condition</span><span class="o">.</span><span class="n">html</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong># Event</strong></p>

<p>注意，<code class="highlighter-rouge">event.wait()</code> 、<code class="highlighter-rouge">event.set()</code> 、<code class="highlighter-rouge">event.clear()</code>  的使用。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c1"># 使用事件 Event
# 也可以用生產者-消費者作為例子
# 在 event.set() 的時候會通知消費者的 event.wait()，啟動消費。然後，將事件清除。event.clear()
</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="評估">評估</h3>

<p>如果把多線程寫好了，但是卻跑的沒有別人寫得快，那情何以堪，所以自己進行評估就很重要了。講到 Python 中的多線程效能評估，就不得不提到 Python 中的 GIL (Global Interpreter Lock)。所以，這邊主要分為兩個部分介紹，<strong>Python 中的 GIL</strong> 和<strong>如何評估 Python 的多線程程式效能</strong>。</p>

<p><em>In CPython, the global interpreter lock, or GIL, is a mutex that prevents multiple native threads from executing Python bytecodes at once. This lock is necessary mainly because CPython’s memory management is not thread-safe. (However, since the GIL exists, other features have grown to depend on the guarantees that it enforces.)</em></p>

<p>上面是官方對 GIL 的解釋。可以理解為：在其中一個 Python 解析器 CPython 中，GIL 是一個互斥鎖，它避免了多個執行緒能同時執行 Python 的源碼。它使得：當有一個執行緒在執行 Python，其他 N 個執行緒都在睡覺或是等待 I/O。想到這裡，就可以想到：第一，Python 的 GIL 的由來和設計；第二，Python 的解釋器如何切換執行緒的執行。第三，如何判斷 Python 中的函數是不是 thread-free 的。</p>

<p>(1) 由來：</p>

<p>由于CPython实现的内存管理不是线程安全，所以需要。它阻止了不同的線程並發的訪問 Python 對象。</p>

<p>(1.1) 如何切換：</p>

<p>有兩種方式，第一種是 <strong>Preemptive (先佔式) MultiTasking</strong>，Python2中若一個執行緒沒有直譯 1000 個 bytecode 指令該執行緒就會釋放 GIL 給其他執行需使用。Python3 中則是通過執行緒的使用時間，沒有超過 15ms 就結束了的話，就會被釋放給其他的執行緒。第二種是 <strong>Cooperative (協調式) multitasking</strong>，即當執行緒被網路 I/O 阻擋時，它會將 GIL 釋放，讓其他執行緒可以執行。所以，兩個執行緒就可以同時等待網絡連接。</p>

<p>(2) 如何評估：</p>

<ol>
  <li>使用 time.time()</li>
  <li>使用 perf 套件，<code class="highlighter-rouge">python -m perf timeit ' XXX '</code></li>
</ol>

<p>(3) 如何判斷 Python 中的函數是不是 thread-free 的？</p>

<p>通過 dis 模塊來查看 bytecode，查看是不是在賦值對象的時候有可能被打斷。</p>

<h3 id="參考資料">參考資料</h3>

<ol>
  <li><a href="https://stackoverflow.com/questions/22885775/what-is-the-difference-between-lock-and-rlock">https://stackoverflow.com/questions/22885775/what-is-the-difference-between-lock-and-rlock</a></li>
  <li><a href="https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/chapter2/09_Thread_synchronization_with_a_condition.html">python-parallel-programmning-cookbook</a></li>
  <li><a href="https://python3-cookbook.readthedocs.io/zh_CN/latest/c12/p09_dealing_with_gil_stop_worring_about_it.html">12.9 Python的全局锁问题</a></li>
  <li><a href="http://cenalulu.github.io/python/gil-in-python/">Python的GIL是什么鬼，多线程性能究竟如何</a></li>
  <li><a href="https://blog.louie.lu/2017/05/19/%E6%B7%B1%E5%85%A5-gil-%E5%A6%82%E4%BD%95%E5%AF%AB%E5%87%BA%E5%BF%AB%E9%80%9F%E4%B8%94-thread-safe-%E7%9A%84-python-grok-the-gil-how-to-write-fast-and-thread-safe-python/">深入 GIL: 如何寫出快速且 thread-safe 的 Python – Grok the GIL: How to write fast and thread-safe Python</a></li>
  <li><a href="https://blog.louie.lu/2017/08/01/%E4%BD%A0%E6%89%80%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84-python-%E6%A8%99%E6%BA%96%E5%87%BD%E5%BC%8F%E5%BA%AB%E7%94%A8%E6%B3%95-06-concurrent-futures/">concurrent.futures — 創立非同步任務 — 你所不知道的 Python 標準函式庫用法 06</a></li>
</ol>

<h3 id="延伸閱讀">延伸閱讀</h3>

<ol>
  <li><a href="https://python3-cookbook.readthedocs.io/zh_CN/latest/preface.html">https://python3-cookbook.readthedocs.io/zh_CN/latest/preface.html</a></li>
  <li><a href="https://linuxgazette.net/107/pai.html">Understanding Threading in Python</a> 推薦</li>
  <li><a href="http://www.dabeaz.com/python/GIL.pdf">Inside the Python GIL</a></li>
  <li><a href="https://wiki.python.org/moin/GlobalInterpreterLock">官方wiki</a></li>
  <li><a href="https://www.tenlong.com.tw/products/9781789533736">Python Parallel Programming Cookbook- Second Edition</a></li>
  <li><a href="https://medium.com/mr-efacani-teatime/concurrency%E8%88%87parallelism%E7%9A%84%E4%B8%8D%E5%90%8C%E4%B9%8B%E8%99%95-1b212a020e30">Concurrency與Parallelism的不同之處</a></li>
  <li><a href="https://medium.com/@alan81920/python-%E7%9A%84-concurrency-%E5%92%8C-parallelization-efeddcb30c4c">Python 的 concurrency 和 parallelization</a></li>
  <li><a href="https://www.pythonf.cn/read/39234">https://www.pythonf.cn/read/39234</a> 例子</li>
</ol>


                </div>

                <!-- 版权声明 -->
                <div style="color: brown;">
    <hr>
    <p>
        <strong>版权声明</strong>：
        本文由 <a href="http://0.0.0.0:4000">tzuw</a> 在 2020年05月12日发表。
        大多是学习笔记和分享，才疏学浅，欢迎指正。本文采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">CC BY-NC-SA 4.0</a>许可协议，非商业转载请注明出处，不得用于商业目的。
        <br>
        文章题目及链接：<a href="/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91/2020/05/12/Python-threading-%E6%A8%A1%E5%A1%8A-with-examples.html">《Python threading 模塊帶範例》</a>
    </p>
    <hr>
</div>


                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/blog/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/2020/05/02/%E5%B7%A5%E5%BB%A0%E6%A8%A1%E5%BC%8F.html" data-toggle="tooltip" data-placement="top" title="設計模式之工廠模式">
                        Previous<br>
                        <span>設計模式之工廠模式</span>
                        </a>
                    </li>
                    
                    
            </ul>
            <hr style="visibility: hidden;">

            

            
        </div>

    <!-- Side Catalog Container -->
    
        <div class="
            col-lg-2 col-lg-offset-0
            visible-lg-block
            sidebar-container
            catalog-container">
            <div class="side-catalog">
                <hr class="hidden-sm hidden-xs">
                <h5>
                    <a class="catalog-toggle" href="#">CATALOG</a>
                </h5>
                <ul class="catalog-body"></ul>
            </div>
        </div>

    

<!-- Sidebar Container -->
        <div class="
            col-lg-8 col-lg-offset-2
            col-md-10 col-md-offset-1
            sidebar-container">

            <!-- Featured Tags -->
            




            <!-- Friends Blog -->
            
<hr>
<h5>WATCH LIST</h5>
<ul class="list-inline">
  
  <li><a href="http://su.gallery/">Su</a></li>
  
  <li><a href="http://mida.re/">乱序</a></li>
  
  <li><a href="https://xuechundesign.github.io">Sherry Wu</a></li>
  
  <li><a href="http://hmqk1995.github.io">Luke 的自留地</a></li>
  
  <li><a href="http://ebnbin.com/">Ebn's Blog</a></li>
  
  <li><a href="http://blog.smdcn.net">SmdCn's Blog</a></li>
  
  <li><a href="http://tiye.me/">JiyinYiyong</a></li>
  
  <li><a href="https://www.ruoyaowu.com/">David's Game</a></li>
  
  <li><a href="http://dhong.co">DHong Say</a></li>
  
  <li><a href="http://ingf.github.io/">尹峰以为</a></li>
  
  <li><a href="https://duter2016.github.io/">优源博客</a></li>
  
  <li><a href="huangxuan.me">Hux Blog</a></li>
  
  <li><a href="https://yizibi.github.io/">一之笔</a></li>
  
  <li><a href="https://www.raymondcamden.com/">RAYMOND CAMDEN</a></li>
  
  <li><a href="https://www.jonathan-petitcolas.com/">Jonathan Petitcolas</a></li>
  
  <li><a href="https://blog.techbridge.cc/">TechBridge 技術共筆部落格</a></li>
  
  <li><a href="">冰封承诺</a></li>
  
  <li><a href="">梁音</a></li>
  
  <li><a href="">ChenYuan</a></li>
  
  <li><a href="">米米的博客</a></li>
  
  <li><a href="">星光的博客</a></li>
  
  <li><a href="">UncleChen</a></li>
  
  <li><a href="">横云断岭</a></li>
  
  <li><a href="">tidy的个人博客</a></li>
  
  <li><a href="">背不起来的就写下来吧</a></li>
  
  <li><a href="">forever杨的个人博客</a></li>
  
  <li><a href="">JerryQu的小站</a></li>
  
  <li><a href="">OneBlog开源博客</a></li>
  
  <li><a href="">Parian's Blog</a></li>
  
  <li><a href="">bieleyang的博客</a></li>
  
  <li><a href="">散尽浮华-博客园</a></li>
  
  <li><a href="">王清培-博客园</a></li>
  
  <li><a href="http://tengj.top/2017/05/05/javabook/">嘟嘟独立博客</a></li>
  
</ul>


        </div>
    </div>
</div>
</article>

<!-- add support for mathjax by voleking-->









    <!-- async load function -->
    <script>
        function async(u, c) {
          var d = document, t = 'script',
              o = d.createElement(t),
              s = d.getElementsByTagName(t)[0];
          o.src = u;
          if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
          s.parentNode.insertBefore(o, s);
        }
    </script>
    <!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
    <script>
        async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
            anchors.options = {
              visible: 'hover',
              placement: 'right',
              // icon: '#'
            };
            anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
        })
    </script>
    <style>
        /* place left on bigger screen */
        @media all and (min-width: 800px) {
            .anchorjs-link{
                position: absolute;
                left: -0.75em;
                font-size: 1.1em;
                margin-top : -0.1em;
            }
        }
    </style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  
  
  
  
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; GINGER 2020
                    <span id="htmer_time" style=""></span>
                    <br>
                    Powered by Huxpro, Jekyll, Maintained By <a href="">tzuw</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=tzuw&repo=tzuw.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/blog/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/blog/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/blog/js/william-blog.min.js"></script>

<!-- Service Worker -->

<script src="/blog/js/snackbar.js"></script>
<script src="/blog/js/sw-registration.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->





<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->



<!-- Baidu Tongji -->



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {

        // interop with multilangual
        if ('' == 'true') {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/blog/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->


<!-- 计算网站运行时间 -->
<script language=JavaScript>
function secondToDate(second) {
 if (!second) {
     return 0;
 }

 var time = new Array(0, 0, 0, 0, 0);

 if (second >= 365 * 24 * 3600) {
     time[0] = parseInt(second / (365 * 24 * 3600));
     second %= 365 * 24 * 3600;
 }

 if (second >= 24 * 3600) {
     time[1] = parseInt(second / (24 * 3600));
     second %= 24 * 3600;
 }

 if (second >= 3600) {
     time[2] = parseInt(second / 3600);
     second %= 3600;
 }

 if (second >= 60) {
     time[3] = parseInt(second / 60);
     second %= 60;
 }

 if (second > 0) {
     time[4] = second;
 }
 return time;
}
<!-- 动态显示网站运行时间 -->
function setTime() {
    var create_time = Math.round(new Date(Date.UTC(2020, 01, 08, 0, 0, 0)).getTime() / 1000);
    var timestamp = Math.round((new Date().getTime() + 8 * 60 * 60 * 1000) / 1000);
    currentTime = secondToDate((timestamp - create_time));
    currentTimeHtml = '本站已运行' + currentTime[0] + '年' + currentTime[1] + '天' + currentTime[2] + '时' + currentTime[3] + '分' + currentTime[4] + '秒';
    document.getElementById("htmer_time").innerHTML = currentTimeHtml;
}
setInterval(setTime, 1000);
</script>

<script type="text/javascript">
$('.navbar-nav a').click(function(e) {
    e.stopPropagation();
    $('.navbar-nav a').removeClass('active');
    $(this).addClass('active');
});
</script>


    <!-- Image to hack wechat -->
    <img src="/blog/img/icon_wechat.png" width="0" height="0" />
    <!-- Migrate from head to bottom, no longer block render and still work -->

    <script type="text/javascript" src="/blog/vendor.9ee51f46156dea4393fc.js"></script><script type="text/javascript" src="/blog/main.0a6f256f3cf60dcdae56.js"></script>

</body>

</html>
